#!/bin/bash
### --------------------------------------------------------------------
### install-deps
### --------------------------------------------------------------------

# When running `pip3 install --user ...` the bin location is in:
# python3 -c "import site; print(site.USER_BASE + '/bin')"

# Exit on error
set -e

# ver_cmp function taken from https://gist.github.com/arvenil/ed695ef374d5df701074
# License of ver_cmp code is included inline here

# Copyright (c) 2012 Yu-Jie Lin
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of
# this software and associated documentation files (the "Software"), to deal in
# the Software without restriction, including without limitation the rights to
# use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
# of the Software, and to permit persons to whom the Software is furnished to do
# so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

_ver_cmp_1() {
  (( "10#$1" == "10#$2" )) && return 0
  (( "10#$1" > "10#$2" )) && return 1
  (( "10#$1" < "10#$2" )) && return 2
  # This should not be happening
  exit 1
}

ver_cmp() {
  local A B i result
  A=(${1//./ })
  B=(${2//./ })
  i=0
  while (( i < ${#A[@]} )) && (( i < ${#B[@]})); do
    _ver_cmp_1 "${A[i]}" "${B[i]}"
    result=$?
    [[ $result =~ [12] ]] && return $result
    let i++
  done
  # Which has more, then it is the newer version
  _ver_cmp_1 "${#A[i]}" "${#B[i]}"
  return $?
}

pip3 install -r requirements.txt --user
pip3 install -r requirements-dev.txt --user

# Setup pre-commit
pre-commit install

# Install conan
if ver_cmp $(pip3 show virtualenv | grep Version | sed 's/.*: //') 20.0.0 == 2
then
    virtualenv --no-site-packages vconan
else
    virtualenv vconan
fi
. vconan/bin/activate
pip3 install --upgrade conan
# conan nonstd-lite
if ! conan remote list | grep -q "nonstd-lite"; then
    conan remote add nonstd-lite https://api.bintray.com/conan/martinmoene/nonstd-lite
fi;
deactivate

# Install arb-compiler-evm
cd packages/arb-compiler-evm
pip3 install -r requirements.txt --user
sudo python3 setup.py develop # TODO: may need sudo or --user here!
cd ../..
