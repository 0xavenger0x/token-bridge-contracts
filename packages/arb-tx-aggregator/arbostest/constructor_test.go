/*
* Copyright 2020, Offchain Labs, Inc.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
 */

package arbostest

import (
	"bytes"
	"context"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/offchainlabs/arbitrum/packages/arb-avm-cpp/cmachine"
	"github.com/offchainlabs/arbitrum/packages/arb-evm/evm"
	"github.com/offchainlabs/arbitrum/packages/arb-evm/message"
	"github.com/offchainlabs/arbitrum/packages/arb-tx-aggregator/arbostestcontracts"
	"github.com/offchainlabs/arbitrum/packages/arb-tx-aggregator/snapshot"
	"github.com/offchainlabs/arbitrum/packages/arb-util/arbos"
	"github.com/offchainlabs/arbitrum/packages/arb-util/common"
	"github.com/offchainlabs/arbitrum/packages/arb-util/inbox"
	"github.com/offchainlabs/arbitrum/packages/arb-validator-core/test"
	"math/big"
	"testing"
)

//var constructorData = hexutil.MustDecode("0x610100604052731820a4b7618bde71dce8cdc73aab6c95905fad24600a60006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503480156200006757600080fd5b506040516200658838038062006588833981810160405260808110156200008d57600080fd5b81019080805190602001909291908051906020019092919080519060200190929190805190602001909291905050506040518060400160405280600481526020017f436f726e000000000000000000000000000000000000000000000000000000008152506040518060400160405280600481526020017f434f524e00000000000000000000000000000000000000000000000000000000815250600067ffffffffffffffff811180156200014157600080fd5b50604051908082528060200260200182016040528015620001715781602001602082028036833780820191505090505b5082600290805190602001906200018a92919062000739565b508160039080519060200190620001a392919062000739565b508060049080519060200190620001bc929190620007c0565b5060008090505b6004805490508110156200026f5760016005600060048481548110620001e557fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508080600101915050620001c3565b50731820a4b7618bde71dce8cdc73aab6c95905fad2473ffffffffffffffffffffffffffffffffffffffff166329965a1d3060405180807f455243373737546f6b656e000000000000000000000000000000000000000000815250600b0190506040518091039020306040518463ffffffff1660e01b8152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019350505050600060405180830381600087803b1580156200037557600080fd5b505af11580156200038a573d6000803e3d6000fd5b50505050731820a4b7618bde71dce8cdc73aab6c95905fad2473ffffffffffffffffffffffffffffffffffffffff166329965a1d3060405180807f4552433230546f6b656e00000000000000000000000000000000000000000000815250600a0190506040518091039020306040518463ffffffff1660e01b8152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019350505050600060405180830381600087803b1580156200049357600080fd5b505af1158015620004a8573d6000803e3d6000fd5b5050505050505060016009819055506000821162000512576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180620065626026913960400191505060405180910390fd5b8373ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff1660601b815250508260a081815250508160c08181525050620005738143620006b060201b6200408b1790919060201c565b60e08181525050600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166329965a1d3060405180807f455243373737546f6b656e73526563697069656e74000000000000000000000081525060150190506040518091039020306040518463ffffffff1660e01b8152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019350505050600060405180830381600087803b1580156200068d57600080fd5b505af1158015620006a2573d6000803e3d6000fd5b5050505050505050620008bd565b6000808284019050838110156200072f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f536166654d6174683a206164646974696f6e206f766572666c6f77000000000081525060200191505060405180910390fd5b8091505092915050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200077c57805160ff1916838001178555620007ad565b82800160010185558215620007ad579182015b82811115620007ac5782518255916020019190600101906200078f565b5b509050620007bc91906200084f565b5090565b8280548282559060005260206000209081019282156200083c579160200282015b828111156200083b5782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190620007e1565b5b5090506200084b919062000877565b5090565b6200087491905b808211156200087057600081600090555060010162000856565b5090565b90565b620008ba91905b80821115620008b657600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055506001016200087e565b5090565b90565b60805160601c60a05160c05160e051615c586200090a60003980612a0d52508061342c5250806133d752508061121152806121885280612c455280612d835280612e935250615c586000f3fe608060405234801561001057600080fd5b50600436106102105760003560e01c80637e3fa2b911610125578063c11aad6e116100ad578063d9f04bc51161007c578063d9f04bc514610e9b578063dd62ed3e14610eb9578063fad8b32a14610f31578063fc673c4f14610f75578063fe9d9303146110f157610210565b8063c11aad6e14610d3b578063c2ceb95f14610d93578063d883f4c114610e01578063d95b637114610e1f57610210565b80639bd9bbc6116100f45780639bd9bbc614610ace578063a9059cbb14610bb3578063b78b52df14610c19578063be6ca56d14610c67578063c018101714610ced57610210565b80637e3fa2b9146109df57806386d1a69f146109fd578063959b8c3f14610a0757806395d89b4114610a4b57610210565b8063313ce567116101a8578063658edb9911610177578063658edb991461085757806370295f9d1461087557806370a08231146108d7578063710b2d8c1461092f578063760534251461098757610210565b8063313ce567146105d9578063421adfa0146105fd578063556f0dc71461069d57806362ad1b83146106bb57610210565b8063095ea7b3116101e4578063095ea7b31461044d57806318160ddd146104b357806323b872dd146104d15780633133e3ab1461055757610210565b806223de2914610215578063059b3eb11461034d57806306e485381461036b57806306fdde03146103ca575b600080fd5b61034b600480360360c081101561022b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190803590602001906401000000008111156102b257600080fd5b8201836020820111156102c457600080fd5b803590602001918460018302840111640100000000831117156102e657600080fd5b90919293919293908035906020019064010000000081111561030757600080fd5b82018360208201111561031957600080fd5b8035906020019184600183028401116401000000008311171561033b57600080fd5b90919293919293905050506111b6565b005b61035561146e565b6040518082815260200191505060405180910390f35b610373611474565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156103b657808201518184015260208101905061039b565b505050509050019250505060405180910390f35b6103d2611502565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156104125780820151818401526020810190506103f7565b50505050905090810190601f16801561043f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6104996004803603604081101561046357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291905050506115a4565b604051808215151515815260200191505060405180910390f35b6104bb6115c7565b6040518082815260200191505060405180910390f35b61053d600480360360608110156104e757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291905050506115d1565b604051808215151515815260200191505060405180910390f35b6105996004803603602081101561056d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061182f565b6040518088815260200187815260200186815260200185815260200184815260200183815260200182815260200197505050505050505060405180910390f35b6105e1611896565b604051808260ff1660ff16815260200191505060405180910390f35b61063f6004803603602081101561061357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061189f565b604051808681526020018581526020018481526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019550505050505060405180910390f35b6106a56118f5565b6040518082815260200191505060405180910390f35b610855600480360360a08110156106d157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291908035906020019064010000000081111561073857600080fd5b82018360208201111561074a57600080fd5b8035906020019184600183028401116401000000008311171561076c57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290803590602001906401000000008111156107cf57600080fd5b8201836020820111156107e157600080fd5b8035906020019184600183028401116401000000008311171561080357600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506118fe565b005b61085f61197a565b6040518082815260200191505060405180910390f35b6108c16004803603604081101561088b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050611980565b6040518082815260200191505060405180910390f35b610919600480360360208110156108ed57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611bab565b6040518082815260200191505060405180910390f35b6109716004803603602081101561094557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611bf3565b6040518082815260200191505060405180910390f35b6109c96004803603602081101561099d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611c99565b6040518082815260200191505060405180910390f35b6109e7611d2a565b6040518082815260200191505060405180910390f35b610a05611d79565b005b610a4960048036036020811015610a1d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061226f565b005b610a536124e6565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610a93578082015181840152602081019050610a78565b50505050905090810190601f168015610ac05780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b610bb160048036036060811015610ae457600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190640100000000811115610b2b57600080fd5b820183602082011115610b3d57600080fd5b80359060200191846001830284011164010000000083111715610b5f57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050612588565b005b610bff60048036036040811015610bc957600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291905050506125b2565b604051808215151515815260200191505060405180910390f35b610c6560048036036040811015610c2f57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291905050506126d6565b005b610ca960048036036020811015610c7d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050612d75565b604051808881526020018715151515815260200186815260200185815260200184815260200183815260200182815260200197505050505050505060405180910390f35b610d3960048036036040811015610d0357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050612fb7565b005b610d7d60048036036020811015610d5157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613374565b6040518082815260200191505060405180910390f35b610dff60048036036060811015610da957600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291905050506134ad565b005b610e09613ad5565b6040518082815260200191505060405180910390f35b610e8160048036036040811015610e3557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613b38565b604051808215151515815260200191505060405180910390f35b610ea3613ce9565b6040518082815260200191505060405180910390f35b610f1b60048036036040811015610ecf57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613cef565b6040518082815260200191505060405180910390f35b610f7360048036036020811015610f4757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613d76565b005b6110ef60048036036080811015610f8b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190640100000000811115610fd257600080fd5b820183602082011115610fe457600080fd5b8035906020019184600183028401116401000000008311171561100657600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192908035906020019064010000000081111561106957600080fd5b82018360208201111561107b57600080fd5b8035906020019184600183028401116401000000008311171561109d57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050613fed565b005b6111b46004803603604081101561110757600080fd5b81019080803590602001909291908035906020019064010000000081111561112e57600080fd5b82018360208201111561114057600080fd5b8035906020019184600183028401116401000000008311171561116257600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050614065565b005b6000851161120f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602c815260200180615a88602c913960400191505060405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1661124e614113565b73ffffffffffffffffffffffffffffffffffffffff16146112d7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f596f752063616e206f6e6c79206275696c64206661726d73206f6e204c414e4481525060200191505060405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff161461135b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e815260200180615adc602e913960400191505060405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff16146113df576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180615a3e6026913960400191505060405180910390fd5b8573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff161415611464576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e815260200180615b0a602e913960400191505060405180910390fd5b5050505050505050565b600c5481565b606060048054806020026020016040519081016040528092919081815260200182805480156114f857602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116114ae575b5050505050905090565b606060028054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561159a5780601f1061156f5761010080835404028352916020019161159a565b820191906000526020600020905b81548152906001019060200180831161157d57829003601f168201915b5050505050905090565b6000806115af614113565b90506115bc81858561411b565b600191505092915050565b6000600154905090565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415611658576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526024815260200180615a646024913960400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614156116de576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180615b8d6026913960400191505060405180910390fd5b60006116e8614113565b9050611716818686866040518060200160405280600081525060405180602001604052806000815250614312565b61174281868686604051806020016040528060008152506040518060200160405280600081525061462c565b6117f585826117f086604051806060016040528060298152602001615b6460299139600860008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461493b9092919063ffffffff16565b61411b565b61182381868686604051806020016040528060008152506040518060200160405280600081525060006149fb565b60019150509392505050565b60008060008060008060008061184489611bab565b905060006118528a43611980565b9050600061185f8b613374565b9050600061186c8c611c99565b90504384848484600c54600d549a509a509a509a509a509a509a5050505050919395979092949650565b60006012905090565b600b6020528060005260406000206000915090508060000154908060010154908060020154908060030154908060040160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905085565b60006001905090565b61190f611909614113565b86613b38565b611964576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602c815260200180615b38602c913960400191505060405180910390fd5b61197385858585856001614d96565b5050505050565b600d5481565b600080600b60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090506000816000015414156119db576000915050611ba5565b43831115611a34576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602a815260200180615bf9602a913960400191505060405180910390fd5b8281600301541115611a91576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603f8152602001806158d7603f913960400191505060405180910390fd5b6000611aac611680836003015461408b90919063ffffffff16565b90506000809050848210611ad857611ad1836003015486614eff90919063ffffffff16565b9050611af2565b611aef836003015483614eff90919063ffffffff16565b90505b6000836000015490506000611b108383614f4990919063ffffffff16565b90506000611b1d89611c99565b90506000611b2a8a613374565b90506000611b7b612710611b6d84611b5f612710611b51898b614f4990919063ffffffff16565b614fcf90919063ffffffff16565b614f4990919063ffffffff16565b614fcf90919063ffffffff16565b90506000611b966305f5e10083614fcf90919063ffffffff16565b90508099505050505050505050505b92915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600080600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090506000816000015490506000826001015490506000821415611c5e5760009350505050611c94565b6000611c8a83611c7c6402540be40085614f4990919063ffffffff16565b614fcf90919063ffffffff16565b9050809450505050505b919050565b600080611ca583611bf3565b90506000611cb1611d2a565b90506000811480611cc25750600082145b15611cd35761271092505050611d25565b6000611d1c620186a0611d17612710611d0986611cfb6127108a614f4990919063ffffffff16565b614fcf90919063ffffffff16565b61408b90919063ffffffff16565b615019565b90508093505050505b919050565b600080600c541415611d3f5760009050611d76565b6000611d6f600c54611d616402540be400600d54614f4990919063ffffffff16565b614fcf90919063ffffffff16565b9050809150505b90565b60026009541415611df2576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f5265656e7472616e637947756172643a207265656e7472616e742063616c6c0081525060200191505060405180910390fd5b6002600981905550611e02614113565b43600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002015414158015611e96575043600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003015414155b611eeb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260398152602001806157ff6039913960400191505060405180910390fd5b611ef3614113565b60018015611f9c576000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541415611f97576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260368152602001806157806036913960400191505060405180910390fd5b612055565b6000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015414612054576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f596f75206d75737420686176652072656c656173656420796f7572206c616e6481525060200191505060405180910390fd5b5b6000600b6000612063614113565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209050600081600001549050600082600001819055506120c781600c54614eff90919063ffffffff16565b600c819055506120e68260010154600d54614eff90919063ffffffff16565b600d819055506121026001600e54614eff90919063ffffffff16565b600e819055507f82e416ba72d10e709b5de7ac16f5f49ff1d94f22d55bf582d353d3c313a1e8dd612131614113565b828460010154604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838152602001828152602001935050505060405180910390a17f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff16639bd9bbc66121ca614113565b836040518363ffffffff1660e01b8152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828152602001806020018281038252600081526020016020019350505050600060405180830381600087803b15801561224857600080fd5b505af115801561225c573d6000803e3d6000fd5b5050505050505050506001600981905550565b8073ffffffffffffffffffffffffffffffffffffffff1661228e614113565b73ffffffffffffffffffffffffffffffffffffffff1614156122fb576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602481526020018061585a6024913960400191505060405180910390fd5b600560008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16156123e55760076000612359614113565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff0219169055612482565b6001600660006123f3614113565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505b61248a614113565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167ff4caeb2d6ca8932a215a353d0703c326ec2d81fc68170f320eb2ab49e9df61f960405160405180910390a350565b606060038054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561257e5780601f106125535761010080835404028352916020019161257e565b820191906000526020600020905b81548152906001019060200180831161256157829003601f168201915b5050505050905090565b6125ad612593614113565b848484604051806020016040528060008152506001614d96565b505050565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415612639576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526024815260200180615a646024913960400191505060405180910390fd5b6000612643614113565b9050612671818286866040518060200160405280600081525060405180602001604052806000815250614312565b61269d81828686604051806020016040528060008152506040518060200160405280600081525061462c565b6126cb81828686604051806020016040528060008152506040518060200160405280600081525060006149fb565b600191505092915050565b6002600954141561274f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f5265656e7472616e637947756172643a207265656e7472616e742063616c6c0081525060200191505060405180910390fd5b600260098190555061275f614113565b43600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154141580156127f3575043600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003015414155b612848576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260398152602001806157ff6039913960400191505060405180910390fd5b612850614113565b600080156128f9576000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015414156128f4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260368152602001806157806036913960400191505060405180910390fd5b6129b2565b6000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154146129b1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f596f75206d75737420686176652072656c656173656420796f7572206c616e6481525060200191505060405180910390fd5b5b60008411612a0b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252604b815260200180615953604b913960600191505060405180910390fd5b7f0000000000000000000000000000000000000000000000000000000000000000431015612a9657683635c9adc5dea00000841115612a95576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603d815260200180615916603d913960400191505060405180910390fd5b5b6000600b6000612aa4614113565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209050848160000181905550438160020181905550438160030181905550858160040160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550612b5385600c5461408b90919063ffffffff16565b600c81905550612b728160010154600d5461408b90919063ffffffff16565b600d819055506001600e600082825401925050819055507f39d12b1a9bde2a7e34304e5a951514ac2a0679475d0a8b35bedf400ebe8b506d612bb2614113565b4388888560010154604051808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018381526020018281526020019550505050505060405180910390a17f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166362ad1b83612c87614113565b30886040518463ffffffff1660e01b8152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828152602001806020018060200183810383526000815260200160200183810382526000815260200160200195505050505050600060405180830381600087803b158015612d4d57600080fd5b505af1158015612d61573d6000803e3d6000fd5b505050505050505060016009819055505050565b6000806000806000806000807f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663d95b6371308b6040518363ffffffff1660e01b8152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019250505060206040518083038186803b158015612e5257600080fd5b505afa158015612e66573d6000803e3d6000fd5b505050506040513d6020811015612e7c57600080fd5b8101908080519060200190929190505050905060007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166370a082318b6040518263ffffffff1660e01b8152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060206040518083038186803b158015612f2e57600080fd5b505afa158015612f42573d6000803e3d6000fd5b505050506040513d6020811015612f5857600080fd5b810190808051906020019092919050505090506000612f768b611bf3565b90506000612f82611d2a565b90506000612f8e613ad5565b9050438585600e548686869b509b509b509b509b509b509b505050505050919395979092949650565b60026009541415613030576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f5265656e7472616e637947756172643a207265656e7472616e742063616c6c0081525060200191505060405180910390fd5b600260098190555081600180156130e2576000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015414156130dd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260368152602001806157806036913960400191505060405180910390fd5b61319b565b6000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541461319a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f596f75206d75737420686176652072656c656173656420796f7572206c616e6481525060200191505060405180910390fd5b5b60008311613211576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260128152602001807f4e6f7468696e6720746f20636f6d706f7374000000000000000000000000000081525060200191505060405180910390fd5b6000600b60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020905061326b84826001015461408b90919063ffffffff16565b816001018190555061328884600d5461408b90919063ffffffff16565b600d819055507f50d5021e89f71b9bd30ac0fbb4c129df45b513ca20d18835fb739f2a784f5cf96132b7614113565b8686604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828152602001935050505060405180910390a161336561333f614113565b856040518060200160405280600081525060405180602001604052806000815250615032565b50505060016009819055505050565b600080600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090506000816000015414156133d0576127109150506134a8565b60006134097f0000000000000000000000000000000000000000000000000000000000000000836002015461408b90919063ffffffff16565b90508043101561341f57612710925050506134a8565b600061348e6127106134807f0000000000000000000000000000000000000000000000000000000000000000613472614e206134648843614eff90919063ffffffff16565b614f4990919063ffffffff16565b614fcf90919063ffffffff16565b61408b90919063ffffffff16565b9050600061349e61753083615019565b9050809450505050505b919050565b60026009541415613526576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f5265656e7472616e637947756172643a207265656e7472616e742063616c6c0081525060200191505060405180910390fd5b60026009819055508243600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154141580156135c3575043600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003015414155b613618576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260398152602001806157ff6039913960400191505060405180910390fd5b83600180156136c2576000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015414156136bd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260368152602001806157806036913960400191505060405180910390fd5b61377b565b6000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541461377a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f596f75206d75737420686176652072656c656173656420796f7572206c616e6481525060200191505060405180910390fd5b5b438411156137d4576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526028815260200180615ab46028913960400191505060405180910390fd5b6000600b60008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020905084816003015410613873576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603281526020018061599e6032913960400191505060405180910390fd5b61387b614113565b73ffffffffffffffffffffffffffffffffffffffff168160040160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614613922576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603881526020018061587e6038913960400191505060405180910390fd5b600061392e8887611980565b9050600081116139a6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260128152602001807f4e6f7468696e6720746f2068617276657374000000000000000000000000000081525060200191505060405180910390fd5b8582600301819055507fb757d83b4531499e2d84501fbd6edd8467f4aa78b20051773e245c703fb891db6139d8614113565b438a8a8a86604051808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018681526020018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838152602001828152602001965050505050505060405180910390a1613ac387826040518060200160405280600081525060405180602001604052806000815250615354565b50505050506001600981905550505050565b600080600c541415613aea5760009050613b35565b6000613b2e600e54613b20600c54613b126402540be400600d54614f4990919063ffffffff16565b614fcf90919063ffffffff16565b614fcf90919063ffffffff16565b9050809150505b90565b60008173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161480613c505750600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff168015613c4f5750600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16155b5b80613ce15750600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff165b905092915050565b600e5481565b6000600860008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b613d7e614113565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415613e02576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001806158b66021913960400191505060405180910390fd5b600560008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615613ef557600160076000613e62614113565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550613f89565b60066000613f01614113565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff02191690555b613f91614113565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f50546e66e5f44d728365dc3908c63bc5cfeeab470722c1677e3073a6ac294aa160405160405180910390a350565b613ffe613ff8614113565b85613b38565b614053576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602c815260200180615b38602c913960400191505060405180910390fd5b61405f84848484615032565b50505050565b614087614070614113565b838360405180602001604052806000815250615032565b5050565b600080828401905083811015614109576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f536166654d6174683a206164646974696f6e206f766572666c6f77000000000081525060200191505060405180910390fd5b8091505092915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614156141a1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602581526020018061575b6025913960400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415614227576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526023815260200180615bd66023913960400191505060405180910390fd5b80600860008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925836040518082815260200191505060405180910390a3505050565b6000731820a4b7618bde71dce8cdc73aab6c95905fad2473ffffffffffffffffffffffffffffffffffffffff1663aabbb8ca877f29ddb589b1fb5fc7cf394961c1adf5f8c6454761adf795e67fe149f658abe89560001b6040518363ffffffff1660e01b8152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060206040518083038186803b1580156143d057600080fd5b505afa1580156143e4573d6000803e3d6000fd5b505050506040513d60208110156143fa57600080fd5b81019080805190602001909291905050509050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614614623578073ffffffffffffffffffffffffffffffffffffffff166375ab97828888888888886040518763ffffffff1660e01b8152600401808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018060200180602001838103835285818151815260200191508051906020019080838360005b83811015614552578082015181840152602081019050614537565b50505050905090810190601f16801561457f5780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b838110156145b857808201518184015260208101905061459d565b50505050905090810190601f1680156145e55780820380516001836020036101000a031916815260200191505b5098505050505050505050600060405180830381600087803b15801561460a57600080fd5b505af115801561461e573d6000803e3d6000fd5b505050505b50505050505050565b6146388686868661567b565b6146a3836040518060600160405280602781526020016157d8602791396000808973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461493b9092919063ffffffff16565b6000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550614736836000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461408b90919063ffffffff16565b6000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff167f06b541ddaa720db2b10a4d0cdac39b8d360425fc073085fac19bc82614677987868686604051808481526020018060200180602001838103835285818151815260200191508051906020019080838360005b8381101561482b578082015181840152602081019050614810565b50505050905090810190601f1680156148585780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b83811015614891578082015181840152602081019050614876565b50505050905090810190601f1680156148be5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a48373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef856040518082815260200191505060405180910390a3505050505050565b60008383111582906149e8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825283818151815260200191508051906020019080838360005b838110156149ad578082015181840152602081019050614992565b50505050905090810190601f1680156149da5780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385039050809150509392505050565b6000731820a4b7618bde71dce8cdc73aab6c95905fad2473ffffffffffffffffffffffffffffffffffffffff1663aabbb8ca877fb281fc8c12954d22544db45de3159a39272895b169a852b314f9cc762e44c53b60001b6040518363ffffffff1660e01b8152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060206040518083038186803b158015614ab957600080fd5b505afa158015614acd573d6000803e3d6000fd5b505050506040513d6020811015614ae357600080fd5b81019080805190602001909291905050509050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614614d0f578073ffffffffffffffffffffffffffffffffffffffff166223de298989898989896040518763ffffffff1660e01b8152600401808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018060200180602001838103835285818151815260200191508051906020019080838360005b83811015614c3a578082015181840152602081019050614c1f565b50505050905090810190601f168015614c675780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b83811015614ca0578082015181840152602081019050614c85565b50505050905090810190601f168015614ccd5780820380516001836020036101000a031916815260200191505b5098505050505050505050600060405180830381600087803b158015614cf257600080fd5b505af1158015614d06573d6000803e3d6000fd5b50505050614d8c565b8115614d8b57614d348673ffffffffffffffffffffffffffffffffffffffff16615681565b15614d8a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252604d8152602001806159f1604d913960600191505060405180910390fd5b5b5b5050505050505050565b600073ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff161415614e1c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806157b66022913960400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161415614ebf576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4552433737373a2073656e6420746f20746865207a65726f206164647265737381525060200191505060405180910390fd5b6000614ec9614113565b9050614ed9818888888888614312565b614ee781888888888861462c565b614ef6818888888888886149fb565b50505050505050565b6000614f4183836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525061493b565b905092915050565b600080831415614f5c5760009050614fc9565b6000828402905082848281614f6d57fe5b0414614fc4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001806159d06021913960400191505060405180910390fd5b809150505b92915050565b600061501183836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250615694565b905092915050565b6000818310615028578161502a565b825b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614156150b8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806158386022913960400191505060405180910390fd5b60006150c2614113565b90506150d1818660008761567b565b6150e081866000878787614312565b61514b84604051806060016040528060238152602001615bb3602391396000808973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461493b9092919063ffffffff16565b6000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506151a284600154614eff90919063ffffffff16565b6001819055508473ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167fa78a9be3a7b862d26933ad85fb11d80ef66b8f972d7cbba06621d583943a4098868686604051808481526020018060200180602001838103835285818151815260200191508051906020019080838360005b83811015615244578082015181840152602081019050615229565b50505050905090810190601f1680156152715780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b838110156152aa57808201518184015260208101905061528f565b50505050905090810190601f1680156152d75780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a3600073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef866040518082815260200191505060405180910390a35050505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614156153f7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4552433737373a206d696e7420746f20746865207a65726f206164647265737381525060200191505060405180910390fd5b6000615401614113565b9050615410816000878761567b565b6154258460015461408b90919063ffffffff16565b60018190555061547c846000808873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461408b90919063ffffffff16565b6000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506154cf8160008787878760016149fb565b8473ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f2fe5be0146f74c5bce36c0b80911af6c7d86ff27e89d5cfa61fc681327954e5d868686604051808481526020018060200180602001838103835285818151815260200191508051906020019080838360005b8381101561556b578082015181840152602081019050615550565b50505050905090810190601f1680156155985780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b838110156155d15780820151818401526020810190506155b6565b50505050905090810190601f1680156155fe5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a38473ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef866040518082815260200191505060405180910390a35050505050565b50505050565b600080823b905060008111915050919050565b60008083118290615740576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825283818151815260200191508051906020019080838360005b838110156157055780820151818401526020810190506156ea565b50505050905090810190601f1680156157325780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b50600083858161574c57fe5b04905080915050939250505056fe4552433737373a20617070726f76652066726f6d20746865207a65726f2061646472657373596f75206d757374206861766520616c6c6f6361746564206c616e6420746f2067726f7720636f726e206f6e20796f7572206661726d4552433737373a2073656e642066726f6d20746865207a65726f20616464726573734552433737373a207472616e7366657220616d6f756e7420657863656564732062616c616e6365596f752063616e206e6f7420616c6c6f636174652f72656c65617365206f72206861727665737420696e207468652073616d6520626c6f636b4552433737373a206275726e2066726f6d20746865207a65726f20616464726573734552433737373a20617574686f72697a696e672073656c66206173206f70657261746f72596f75206d757374206265207468652064656c65676174656420686172766573746572206f662074686520736f75726365416464726573734552433737373a207265766f6b696e672073656c66206173206f70657261746f72596f752063616e206f6e6c79207370656369667920626c6f636b73206174206f72206168656164206f66206c6173742068617276657374656420626c6f636b596f752063616e206f6e6c7920616c6c6f636174652061206d6178696d756d206f662031303030204c414e4420647572696e67206661696c736166652e596f75206d7573742070726f76696465206120706f73697469766520616d6f756e7420746f20616c6c6f63617465204c414e4420666f722067726f77696e6720434f524e2061206661726d596f752063616e206f6e6c792068617276657374206168656164206f66206c6173742068617276657374656420626c6f636b536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f774552433737373a20746f6b656e20726563697069656e7420636f6e747261637420686173206e6f20696d706c656d656e74657220666f7220455243373737546f6b656e73526563697069656e7446756e6473206d75737420626520636f6d696e6720696e746f206120434f524e20746f6b656e4552433737373a207472616e7366657220746f20746865207a65726f2061646472657373596f75206d7573742072656365697665206120706f736974697665206e756d626572206f6620746f6b656e73596f752063616e206f6e6c79206861727665737420757020746f2063757272656e7420626c6f636b4f6e6c7920434f524e20636f6e74726163742063616e2073656e6420697473656c66204c414e4420746f6b656e7357687920776f756c6420434f524e20636f6e74726163742073656e6420746f6b656e7320746f20697473656c663f4552433737373a2063616c6c6572206973206e6f7420616e206f70657261746f7220666f7220686f6c6465724552433737373a207472616e7366657220616d6f756e74206578636565647320616c6c6f77616e63654552433737373a207472616e736665722066726f6d20746865207a65726f20616464726573734552433737373a206275726e20616d6f756e7420657863656564732062616c616e63654552433737373a20617070726f766520746f20746865207a65726f2061646472657373596f752063616e206f6e6c792063616c63756c61746520757020746f2063757272656e7420626c6f636ba2646970667358221220536bc43e4cf581cdc6acedf4a450bc7099c18358f6621e46ec6a621601212b0864736f6c634300060900336d617854696d65526577617264206d757374206265206174206c65617374203120626c6f636b")
var constructorData = hexutil.MustDecode(arbostestcontracts.FibonacciBin)

func TestContructor(t *testing.T) {
	client, pks := test.SimulatedBackend()

	tx := types.NewContractCreation(0, big.NewInt(0), 1000000, big.NewInt(0), constructorData)
	signedTx, err := types.SignTx(tx, types.HomesteadSigner{}, pks[0])
	if err != nil {
		t.Fatal(err)
	}

	if err := client.SendTransaction(context.Background(), signedTx); err != nil {
		t.Fatal(err)
	}
	client.Commit()
	ethReceipt, err := client.TransactionReceipt(context.Background(), signedTx.Hash())
	if err != nil {
		t.Fatal(err)
	}

	chainTime := inbox.ChainTime{
		BlockNum:  common.NewTimeBlocksInt(0),
		Timestamp: big.NewInt(0),
	}

	l2Message, err := message.NewL2Message(message.NewCompressedECDSAFromEth(signedTx))
	if err != nil {
		t.Fatal(err)
	}

	chain := common.RandAddress()
	inboxMessages := make([]inbox.InboxMessage, 0)
	inboxMessages = append(inboxMessages, message.NewInboxMessage(initMsg(), chain, big.NewInt(0), chainTime))
	inboxMessages = append(inboxMessages, message.NewInboxMessage(
		l2Message,
		common.RandAddress(),
		big.NewInt(1),
		chainTime,
	))

	mach, err := cmachine.New(arbos.Path())
	if err != nil {
		t.Fatal(err)
	}

	// Last parameter returned is number of steps executed
	assertion, _ := mach.ExecuteAssertion(1000000000, inboxMessages, 0)
	logs := assertion.ParseLogs()

	if len(logs) != 1 {
		t.Fatal("unexpected log count", len(logs))
	}

	res, err := evm.NewTxResultFromValue(logs[0])
	if err != nil {
		t.Fatal(err)
	}

	if res.ResultCode == evm.ReturnCode {
		if ethReceipt.Status != 1 {
			t.Fatal("arb tx succeeded but eth tx failed")
		}
		t.Log("constructors succeeded")
	} else {
		if ethReceipt.Status != 0 {
			t.Fatal("arb tx failed but eth tx succeeded")
		}
		t.Log("constructors failed")
	}

	if res.ResultCode != evm.ReturnCode {
		// Nothing else to check if the tx failed
		return
	}

	arbAddress, err := getConstructorResult(res)
	if err != nil {
		t.Fatal(err)
	}
	if arbAddress.ToEthAddress() != ethReceipt.ContractAddress {
		t.Error("contracts deployed at different addresses")
	}

	ethCode, err := client.CodeAt(context.Background(), ethReceipt.ContractAddress, nil)
	if err != nil {
		t.Fatal(err)
	}

	snap := snapshot.NewSnapshot(mach, chainTime, message.ChainAddressToID(chain), big.NewInt(9999999))
	arbCode, err := snap.GetCode(arbAddress)
	if err != nil {
		t.Fatal(err)
	}

	if !bytes.Equal(arbCode, ethCode) {
		t.Error("deployed code is different")
	}
}
